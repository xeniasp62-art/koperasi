<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pinjaman & Angsuran</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
header{background:#1e90ff;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center}
button{cursor:pointer}
.container{padding:20px}
.tabs{display:flex;gap:10px;margin-bottom:15px}
.tabs button{flex:1;padding:10px;border:none;border-radius:6px;background:#ddd}
.tabs button.active{background:#1e90ff;color:white}
.tabcontent{display:none}
form,table{background:white;padding:15px;border-radius:8px;margin-bottom:15px}
input,select{width:100%;padding:8px;margin:5px 0}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#eee}
.in{color:green}
.out{color:red}
</style>
</head>

<body>

<header>
  <h3>ðŸ“Œ Pinjaman & Angsuran</h3>
  <div>
    <button onclick="back()">â¬… Dashboard</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

<div class="tabs">
  <button class="tablink active" onclick="openTab('pinjaman',this)">Pinjaman</button>
  <button class="tablink" onclick="openTab('bayar',this)">Bayar Angsuran</button>
</div>

<!-- ================= PINJAMAN ================= -->
<div id="pinjaman" class="tabcontent" style="display:block">
<form onsubmit="simpanPinjaman(event)">
<h4>Tambah Pinjaman</h4>
<select id="anggotaPinjam" required></select>
<input type="number" id="jumlahPinjam" placeholder="Jumlah Pinjaman" required>
<input type="number" id="bungaPinjam" placeholder="Bunga (%)" required>
<input type="number" id="tenorPinjam" placeholder="Tenor (bulan)" required>
<input type="text" id="angsuranPinjam" readonly placeholder="Angsuran / bulan">
<button>Simpan</button>
</form>

<table>
<thead>
<tr>
<th>Anggota</th><th>Pinjaman</th><th>Sisa</th><th>Status</th>
</tr>
</thead>
<tbody id="listPinjaman"></tbody>
</table>
</div>

<!-- ================= BAYAR ================= -->
<div id="bayar" class="tabcontent">
<form onsubmit="simpanAngsuran(event)">
<h4>Bayar Angsuran</h4>
<select id="anggotaBayar" onchange="loadPinjamanDropdown()" required></select>
<select id="pinjamanBayar" required></select>
<input type="number" id="jumlahBayar" placeholder="Jumlah Bayar" required>
<button>Simpan</button>
</form>

<table>
<thead>
<tr>
<th>Anggota</th><th>Jumlah</th><th>Tanggal</th>
</tr>
</thead>
<tbody id="listBayar"></tbody>
</table>
</div>

</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script>
cekLogin();

/* ================= UTIL ================= */
function rupiah(n){return "Rp "+(Number(n)||0).toLocaleString("id-ID")}
function back(){location.replace("dashboard.html")}
function logout(){
  if(confirm("Logout?")){
    localStorage.removeItem("login");
    location.replace("login.html");
  }
}

/* ================= TAB ================= */
function openTab(id,btn){
  document.querySelectorAll(".tabcontent").forEach(t=>t.style.display="none");
  document.querySelectorAll(".tablink").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).style.display="block";
  btn.classList.add("active");
}

/* ================= LOAD ANGGOTA ================= */
function loadAnggota(){
  const db=getDB();
  ["anggotaPinjam","anggotaBayar"].forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML="<option value=''>-- Pilih Anggota --</option>";
    db.anggota.forEach(a=>{
      s.innerHTML+=`<option value="${a.id}">${a.nama}</option>`;
    });
  });
}

/* ================= HITUNG ================= */
["jumlahPinjam","bungaPinjam","tenorPinjam"].forEach(id=>{
  document.getElementById(id).addEventListener("input",()=>{
    const j=+jumlahPinjam.value,b=+bungaPinjam.value,t=+tenorPinjam.value;
    if(j&&b&&t){
      const total=j+(j*b/100*t);
      angsuranPinjam.value=rupiah(Math.ceil(total/t));
    }
  });
});

/* ================= SIMPAN PINJAMAN ================= */
function simpanPinjaman(e){
  e.preventDefault();
  const db=getDB();
  db.pinjaman.push({
    id:"PJ"+Date.now(),
    anggota_id:anggotaPinjam.value,
    jumlah:+jumlahPinjam.value,
    bunga:+bungaPinjam.value,
    tenor:+tenorPinjam.value,
    sisa:+jumlahPinjam.value,
    status:"Aktif"
  });
  saveDB(db);
  e.target.reset();
  loadPinjaman();
}

/* ================= LOAD PINJAMAN ================= */
function loadPinjaman(){
  const db=getDB(),tb=listPinjaman;
  tb.innerHTML="";
  db.pinjaman.forEach(p=>{
    const a=db.anggota.find(x=>x.id===p.anggota_id);
    tb.innerHTML+=`
    <tr>
      <td>${a?.nama||"-"}</td>
      <td>${rupiah(p.jumlah)}</td>
      <td>${rupiah(p.sisa)}</td>
      <td>${p.status}</td>
    </tr>`;
  });
}

/* ================= SIMPAN ANGSURAN ================= */
function simpanAngsuran(e){
  e.preventDefault();
  const db=getDB();
  const p=db.pinjaman.find(x=>x.id===pinjamanBayar.value);
  p.sisa-=+jumlahBayar.value;
  if(p.sisa<=0){p.sisa=0;p.status="Lunas";}
  db.transaksi.push({
    id:"TR"+Date.now(),
    pinjaman_id:p.id,
    jumlah:+jumlahBayar.value,
    jenis:"BAYAR",
    tanggal:new Date().toISOString().slice(0,10)
  });
  saveDB(db);
  e.target.reset();
  loadPinjaman(); loadBayar();
}

/* ================= LOAD BAYAR ================= */
function loadBayar(){
  const db=getDB(),tb=listBayar;
  tb.innerHTML="";
  db.transaksi.filter(t=>t.jenis==="BAYAR").forEach(t=>{
    const p=db.pinjaman.find(x=>x.id===t.pinjaman_id);
    const a=db.anggota.find(x=>x.id===p.anggota_id);
    tb.innerHTML+=`
    <tr>
      <td>${a.nama}</td>
      <td>${rupiah(t.jumlah)}</td>
      <td>${t.tanggal}</td>
    </tr>`;
  });
}

/* ================= DROPDOWN ================= */
function loadPinjamanDropdown(){
  const db=getDB(),s=pinjamanBayar;
  s.innerHTML="<option value=''>-- Pilih Pinjaman --</option>";
  db.pinjaman.filter(p=>p.anggota_id===anggotaBayar.value && p.sisa>0)
    .forEach(p=>s.innerHTML+=`<option value="${p.id}">${rupiah(p.sisa)}</option>`);
}

/* ================= INIT ================= */
loadAnggota(); loadPinjaman(); loadBayar();
</script>
</body>
</html>